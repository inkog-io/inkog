# Example: Inkog Diff Mode Workflow
#
# This workflow demonstrates baseline/diff mode for mature projects:
# - Main branch updates the security baseline
# - PRs only fail on NEW critical/high findings (not pre-existing issues)
#
# This allows incremental security adoption without breaking existing PRs.

name: AI Agent Security (Diff Mode)

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

permissions:
  contents: write         # Required for baseline commit
  security-events: write  # Required for SARIF upload
  pull-requests: write    # Required for PR comments

jobs:
  # Update baseline on main branch pushes
  update-baseline:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    name: Update Security Baseline

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Inkog Scan & Update Baseline
        uses: inkog-io/inkog@v1
        with:
          path: '.'
          policy: 'balanced'
          update-baseline: 'true'
          fail-on-findings: 'false'  # Don't fail on main, just update baseline
          sarif-upload: 'true'

      - name: Commit Baseline
        run: |
          if [ -f .inkog-baseline.json ]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add .inkog-baseline.json
            git diff --cached --quiet || git commit -m "chore: update inkog security baseline"
            git push
          fi

  # Check for regressions on PRs
  check-regression:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    name: Check Security Regression

    steps:
      - name: Checkout PR
        uses: actions/checkout@v4

      - name: Download baseline from main
        run: |
          git fetch origin main
          git show origin/main:.inkog-baseline.json > .inkog-baseline.json 2>/dev/null || echo '{"findings":[]}' > .inkog-baseline.json

      - name: Run Diff Scan
        uses: inkog-io/inkog@v1
        with:
          path: '.'
          policy: 'balanced'
          diff: 'true'
          baseline: '.inkog-baseline.json'
          fail-on-findings: 'true'  # Fails only on NEW critical/high findings
          comment-on-pr: 'true'
          sarif-upload: 'true'
